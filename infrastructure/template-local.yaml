AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31

Description: >
  Myelin Base AI Platform - Local Development Template (No Cognito)

# ============================================
# Parameters
# ============================================
Parameters:
  ProjectName:
    Type: String
    Default: myelinbase

  FrontendUrl:
    Type: String
    Default: "http://localhost:3001"

  UseBedrock:
    Type: String
    Default: "false"

  PineconeApiKeySecretName:
    Type: String
    Default: pinecone-api-key
  PineconeIndexName:
    Type: String
    Default: myelinbase-documents

  DynamoDBEndpoint:
    Type: String
    Default: "http://host.docker.internal:8000"
  S3Endpoint:
    Type: String
    Default: "http://host.docker.internal:4566"
  LocalstackEndpoint:
    Type: String
    Default: "http://host.docker.internal:4566"

  ChatModelId:
    Type: String
    Default: "anthropic.claude-3-haiku-20240307-v1:0"
  EmbeddingModelId:
    Type: String
    Default: "amazon.titan-embed-text-v1"

# ============================================
# Globals
# ============================================
Globals:
  Function:
    Runtime: nodejs20.x
    Timeout: 30
    MemorySize: 512
    Architectures: [arm64]
    Environment:
      Variables:
        STAGE: local
        POWERTOOLS_SERVICE_NAME: !Ref ProjectName
        LOG_LEVEL: DEBUG
        DYNAMODB_ENDPOINT: !Ref DynamoDBEndpoint
        S3_ENDPOINT: !Ref S3Endpoint
        LOCALSTACK_ENDPOINT: !Ref LocalstackEndpoint
        ALLOWED_ORIGINS: !Ref FrontendUrl
        CHAT_MODEL_ID: !Ref ChatModelId
        EMBEDDING_MODEL_ID: !Ref EmbeddingModelId
        PINECONE_API_KEY_SECRET_NAME: !Ref PineconeApiKeySecretName
        PINECONE_INDEX_NAME: !Ref PineconeIndexName
        USE_BEDROCK: !Ref UseBedrock

# ============================================
# Resources
# ============================================
Resources:
  # ---------------------------------------------------
  # API Gateway (認証なし)
  # ---------------------------------------------------
  LocalApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub ${ProjectName}-local-api
      StageName: local
      Cors:
        AllowMethods: "'*'"
        AllowHeaders: "'*'"
        AllowOrigin: !Sub "'${FrontendUrl}'"
        AllowCredentials: "'true'"
      # 認証なし

  # ---------------------------------------------------
  # Chat Agent API
  # ---------------------------------------------------
  ChatAgentFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${ProjectName}-local-agent
      CodeUri: .
      Handler: index.handler
      Description: Streaming Chat Agent (Local)
      Timeout: 300
      MemorySize: 1024
      FunctionUrlConfig:
        AuthType: NONE
        InvokeMode: RESPONSE_STREAM
        Cors:
          AllowCredentials: true
          AllowHeaders: ["*"]
          AllowMethods: [POST]
          AllowOrigins:
            - !Ref FrontendUrl
      Environment:
        Variables:
          TABLE_NAME: !Sub ${ProjectName}-local-chat-history
          DOCUMENT_TABLE_NAME: !Sub ${ProjectName}-local-documents
          USER_POOL_ID: "local-user-pool"
          CLIENT_ID: "local-client-id"
          MODEL_ID: anthropic.claude-3-haiku-20240307-v1:0
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource: "*"
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
                - secretsmanager:GetSecretValue
              Resource: "*"
      Events:
        Chat:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /chat
            Method: POST
        ChatStream:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /chat/stream
            Method: POST
        ChatFeedback:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /chat/feedback
            Method: POST
        GetSessions:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /chat/sessions
            Method: GET
        GetSession:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /chat/sessions/{sessionId}
            Method: GET
        UpdateSession:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /chat/sessions/{sessionId}
            Method: PATCH
        DeleteSession:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /chat/sessions/{sessionId}
            Method: DELETE
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        OutExtension:
          - .js=.cjs
        Format: cjs
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/functions/chat/index.ts
        External:
          - "@aws-sdk/*"

  # ---------------------------------------------------
  # Doc Processor
  # ---------------------------------------------------
  DocProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${ProjectName}-local-doc-processor
      CodeUri: .
      Handler: index.handler
      Timeout: 120
      MemorySize: 1024
      Environment:
        Variables:
          TABLE_NAME: !Sub ${ProjectName}-local-documents
          BUCKET_NAME: !Sub ${ProjectName}-local-docs
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
                - s3:*
                - bedrock:InvokeModel
                - secretsmanager:GetSecretValue
              Resource: "*"
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        OutExtension:
          - .js=.cjs
        Format: cjs
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/functions/processor/index.ts
        External:
          - "@aws-sdk/*"

  # ---------------------------------------------------
  # Ingestion Trigger
  # ---------------------------------------------------
  IngestionTriggerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${ProjectName}-local-trigger
      CodeUri: .
      Handler: index.handler
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          STATE_MACHINE_ARN: "arn:aws:states:us-east-1:000000000000:stateMachine:local-rag-pipeline"
          PROCESSOR_FUNCTION_NAME: !Sub ${ProjectName}-local-doc-processor
          LOCALSTACK_ENDPOINT: !Ref LocalstackEndpoint
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - states:StartExecution
                - lambda:InvokeFunction
              Resource: "*"
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        OutExtension:
          - .js=.cjs
        Format: cjs
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/functions/trigger/index.ts
        External:
          - "@aws-sdk/*"

  # ---------------------------------------------------
  # Documents API
  # ---------------------------------------------------
  DocumentsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${ProjectName}-local-documents
      CodeUri: .
      Handler: index.handler
      Timeout: 30
      Environment:
        Variables:
          TABLE_NAME: !Sub ${ProjectName}-local-documents
          BUCKET_NAME: !Sub ${ProjectName}-local-docs
          PRESIGNED_URL_EXPIRY: "900"
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
                - s3:*
              Resource: "*"
      Events:
        GetDocuments:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /documents
            Method: GET
        UploadRequest:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /documents/upload
            Method: POST
        GetDocument:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /documents/{id}
            Method: GET
        GetDownloadUrl:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /documents/{id}/download-url
            Method: GET
        DeleteDocument:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /documents/{id}
            Method: DELETE
        BatchDeleteDocuments:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /documents/batch-delete
            Method: POST
        UpdateTags:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /documents/{id}/tags
            Method: PATCH
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        OutExtension:
          - .js=.cjs
        Format: cjs
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/functions/documents/index.ts
        External:
          - "@aws-sdk/*"

  # ---------------------------------------------------
  # Health Check
  # ---------------------------------------------------
  HealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${ProjectName}-local-health
      CodeUri: .
      Handler: index.handler
      Description: Health check endpoint
      Timeout: 5
      MemorySize: 128
      Events:
        HealthCheck:
          Type: Api
          Properties:
            RestApiId: !Ref LocalApiGateway
            Path: /health
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        OutExtension:
          - .js=.cjs
        Format: cjs
        Minify: true
        Target: es2022
        EntryPoints:
          - src/functions/health/index.ts

# ============================================
# Outputs
# ============================================
Outputs:
  ChatAgentEndpoint:
    Description: Streaming Function URL for Chat Agent
    Value: !GetAtt ChatAgentFunctionUrl.FunctionUrl

  ApiEndpoint:
    Description: REST API Endpoint
    Value: !Sub https://${LocalApiGateway}.execute-api.${AWS::Region}.amazonaws.com/local
